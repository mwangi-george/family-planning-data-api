<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Analytics Charts – Test Harness</title>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 24px;
            background: #f9fafb;
            color: #111827;
        }

        header {
            margin-bottom: 16px;
        }

        h1 {
            font-size: 1.5rem;
            margin: 0 0 6px 0;
        }

        p {
            color: #4b5563;
            max-width: 980px;
            margin: 0;
        }

        /* Tabs */
        .tabs {
            margin-top: 16px;
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            border: 1px solid #d1d5db;
            background: white;
            color: #111827;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }

        .tab-btn[aria-selected="true"] {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        .tab-desc {
            margin-top: 10px;
            color: #6b7280;
            font-size: 12px;
        }

        /* Filters */
        .filters {
            margin-top: 14px;
            padding: 14px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 10px;
            align-items: end;
        }

        .field {
            grid-column: span 3;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 0;
        }

        .field.wide { grid-column: span 6; }
        .field.small { grid-column: span 2; }

        label {
            font-size: 12px;
            color: #374151;
        }

        input, select {
            padding: 10px 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            background: #fff;
        }

        input:focus, select:focus {
            border-color: #93c5fd;
            box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.35);
        }

        .actions {
            grid-column: span 12;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-top: 6px;
        }

        button.primary {
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            cursor: pointer;
            background: #2563eb;
            color: #fff;
        }

        button.secondary {
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            cursor: pointer;
            background: #e5e7eb;
            color: #111827;
        }

        .meta {
            color: #6b7280;
            font-size: 12px;
            overflow-wrap: anywhere;
            max-width: 100%;
        }

        .hint {
            margin-top: 10px;
            color: #6b7280;
            font-size: 12px;
        }

        /* Chart */
        .chart-container {
            margin-top: 14px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            height: 650px;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        @media (max-width: 1100px) {
            .field { grid-column: span 6; }
            .field.small { grid-column: span 6; }
            .field.wide { grid-column: span 12; }
        }

        @media (max-width: 640px) {
            .field { grid-column: span 12; }
            .field.small { grid-column: span 12; }
        }
    </style>
</head>
<body>

<header>
    <h1>Analytics (Plotly) – Test Harness</h1>
    <p>
        Switch tabs to test different endpoints. Adjust the parameters below, then click <b>Load chart</b>
        to refetch the embedded Plotly HTML in the iframe.
    </p>

    <div class="tabs" role="tablist" aria-label="Analytics chart tabs">
        <button
            id="tab-time-series"
            class="tab-btn"
            role="tab"
            aria-selected="true"
            aria-controls="panel"
            type="button"
            data-tab="time_series"
        >
            Time series
        </button>

        <button
            id="tab-anomalies"
            class="tab-btn"
            role="tab"
            aria-selected="false"
            aria-controls="panel"
            type="button"
            data-tab="anomalies"
        >
            Anomaly detection
        </button>
    </div>

    <div class="tab-desc" id="tabDesc">
        Time series endpoint: <span class="meta" id="activeEndpointLabel"></span>
    </div>
</header>

<section class="filters" id="panel" role="tabpanel" aria-labelledby="tab-time-series">
    <div class="grid">
        <div class="field wide">
            <label for="baseUrl">Base URL</label>
            <input id="baseUrl" type="text" />
        </div>

        <div class="field">
            <label for="analytic">Analytic</label>
            <input id="analytic" type="text" value="POPs" />
        </div>

        <div class="field">
            <label for="method">Method</label>
            <input id="method" type="text" value="Consumption" />
        </div>

        <div class="field">
            <label for="orgUnit">Org unit</label>
            <input id="orgUnit" type="text" value="Kenya" />
        </div>

        <div class="field">
            <label for="startDate">Start date</label>
            <input id="startDate" type="date" value="2020-01-01" />
        </div>

        <div class="field">
            <label for="endDate">End date</label>
            <input id="endDate" type="date" value="2025-12-01" />
        </div>

        <!-- Plot-type is tab-specific. We'll update label + options dynamically -->
        <div class="field">
            <label for="plotType" id="plotTypeLabel">Plot type</label>
            <select id="plotType"></select>
        </div>

        <!-- Anomaly-specific controls (shown only on anomalies tab) -->
        <div class="field" id="normalRangeField" style="display:none;">
            <label for="normalRangeWidth">Normal range width</label>
            <input id="normalRangeWidth" type="number" step="0.01" min="0" max="1" value="0.15" />
        </div>

        <div class="field" id="maxAnomaliesField" style="display:none;">
            <label for="maxAnomalies">Max anomalies</label>
            <input id="maxAnomalies" type="number" step="0.01" min="0" max="1" value="0.3" />
        </div>

        <div class="field">
            <label for="visualizeAllMethods">Visualize all methods</label>
            <select id="visualizeAllMethods">
                <option value="false" selected>false</option>
                <option value="true">true</option>
            </select>
        </div>

        <div class="actions">
            <button class="primary" id="loadBtn" type="button">Load chart</button>
            <button class="secondary" id="resetBtn" type="button">Reset defaults</button>
            <span class="meta" id="builtUrl"></span>
        </div>
    </div>

    <div class="hint">
        Tip: Press <b>Enter</b> in any field to load the chart. Use the tabs to switch endpoints.
    </div>
</section>

<section class="chart-container">
    <iframe id="chartFrame" loading="lazy"></iframe>
</section>

<script>
    // --- Endpoints + defaults ---
    const ENDPOINTS = {
        time_series: {
            label: "Time series",
            baseUrl: "http://127.0.0.1:9000/api/v1/analytics/time-series",
            plotTypeLabel: "Plot type",
            plotTypeOptions: [
                { value: "time_series", text: "time_series" },
                { value: "seasonal_diagnostics", text: "seasonal_diagnostics" },
                { value: "stl_diagnostics", text: "stl_diagnostics" },
            ],
            defaultPlotType: "time_series",
            hasAnomalyControls: false,
        },
        anomalies: {
            label: "Anomaly detection",
            baseUrl: "http://127.0.0.1:9000/api/v1/analytics/anomaly-detection",
            plotTypeLabel: "Plot type",
            plotTypeOptions: [
                { value: "anomalies", text: "anomalies" },
            ],
            defaultPlotType: "anomalies",
            hasAnomalyControls: true,
            defaults: {
                normal_range_width: "0.15",
                max_anomalies: "0.3",
            },
        },
    };

    // Shared defaults for common fields
    const COMMON_DEFAULTS = {
        analytic: "POPs",
        method: "Consumption",
        orgUnit: "Kenya",
        startDate: "2020-01-01",
        endDate: "2025-12-01",
        visualizeAllMethods: "false",
    };

    let activeTab = "time_series";

    const els = {
        // tabs
        tabTimeSeries: document.getElementById("tab-time-series"),
        tabAnomalies: document.getElementById("tab-anomalies"),
        activeEndpointLabel: document.getElementById("activeEndpointLabel"),

        // form
        baseUrl: document.getElementById("baseUrl"),
        analytic: document.getElementById("analytic"),
        method: document.getElementById("method"),
        orgUnit: document.getElementById("orgUnit"),
        startDate: document.getElementById("startDate"),
        endDate: document.getElementById("endDate"),
        plotTypeLabel: document.getElementById("plotTypeLabel"),
        plotType: document.getElementById("plotType"),
        visualizeAllMethods: document.getElementById("visualizeAllMethods"),
        normalRangeField: document.getElementById("normalRangeField"),
        maxAnomaliesField: document.getElementById("maxAnomaliesField"),
        normalRangeWidth: document.getElementById("normalRangeWidth"),
        maxAnomalies: document.getElementById("maxAnomalies"),

        // actions
        loadBtn: document.getElementById("loadBtn"),
        resetBtn: document.getElementById("resetBtn"),
        builtUrl: document.getElementById("builtUrl"),

        // chart
        chartFrame: document.getElementById("chartFrame"),

        // panel
        panel: document.getElementById("panel"),
    };

    function setTab(tabKey) {
        activeTab = tabKey;

        // ARIA + selected styling
        els.tabTimeSeries.setAttribute("aria-selected", String(tabKey === "time_series"));
        els.tabAnomalies.setAttribute("aria-selected", String(tabKey === "anomalies"));

        // Update panel label reference
        els.panel.setAttribute("aria-labelledby", tabKey === "time_series" ? "tab-time-series" : "tab-anomalies");

        // Update endpoint label
        els.activeEndpointLabel.textContent = ENDPOINTS[activeTab].baseUrl;

        // Update base url field
        els.baseUrl.value = ENDPOINTS[activeTab].baseUrl;

        // Update plotType label/options
        els.plotTypeLabel.textContent = ENDPOINTS[activeTab].plotTypeLabel;
        hydratePlotTypeOptions();

        // Show/hide anomaly-specific controls
        const showAnomalyControls = ENDPOINTS[activeTab].hasAnomalyControls;
        els.normalRangeField.style.display = showAnomalyControls ? "block" : "none";
        els.maxAnomaliesField.style.display = showAnomalyControls ? "block" : "none";

        // Ensure plot type default for this tab
        els.plotType.value = ENDPOINTS[activeTab].defaultPlotType;

        // Set anomaly defaults (but do not overwrite if user already edited)
        if (showAnomalyControls) {
            if (!els.normalRangeWidth.value) els.normalRangeWidth.value = ENDPOINTS.anomalies.defaults.normal_range_width;
            if (!els.maxAnomalies.value) els.maxAnomalies.value = ENDPOINTS.anomalies.defaults.max_anomalies;
        }

        // Update built URL preview + reload chart
        loadChart();
    }

    function hydratePlotTypeOptions() {
        const options = ENDPOINTS[activeTab].plotTypeOptions;

        // Clear
        while (els.plotType.firstChild) els.plotType.removeChild(els.plotType.firstChild);

        for (const opt of options) {
            const optionEl = document.createElement("option");
            optionEl.value = opt.value;
            optionEl.textContent = opt.text;
            els.plotType.appendChild(optionEl);
        }
    }

    function buildUrl() {
        const base = (els.baseUrl.value || "").trim();
        const url = new URL(base);
        const params = new URLSearchParams();

        // Common params
        const analytic = els.analytic.value.trim();
        if (analytic) params.set("analytic", analytic);

        const method = els.method.value.trim();
        if (method) params.set("method", method);

        const orgUnit = els.orgUnit.value.trim();
        if (orgUnit) params.set("org_unit", orgUnit);

        const startDate = els.startDate.value;
        if (startDate) params.set("start_date", startDate);

        const endDate = els.endDate.value;
        if (endDate) params.set("end_date", endDate);

        const plotType = els.plotType.value;
        if (plotType) params.set("plot_type", plotType);

        const visualizeAllMethods = els.visualizeAllMethods.value;
        if (visualizeAllMethods) params.set("visualize_all_methods", visualizeAllMethods);

        // Tab-specific params
        if (activeTab === "anomalies") {
            const normalRangeWidth = (els.normalRangeWidth.value || "").trim();
            const maxAnomalies = (els.maxAnomalies.value || "").trim();

            if (normalRangeWidth) params.set("normal_range_width", normalRangeWidth);
            if (maxAnomalies) params.set("max_anomalies", maxAnomalies);
        }

        url.search = params.toString();
        return url.toString();
    }

    function loadChart() {
        let nextUrl;
        try {
            nextUrl = buildUrl();
        } catch (e) {
            els.builtUrl.textContent = "Invalid base URL. Please fix it.";
            return;
        }

        // Show the URL we’re about to load
        els.builtUrl.textContent = nextUrl;

        // Cache-bust so changes always refetch even if the URL is the same
        const cacheBustUrl = new URL(nextUrl);
        cacheBustUrl.searchParams.set("_ts", String(Date.now()));

        // Load iframe
        els.chartFrame.src = cacheBustUrl.toString();
    }

    function resetDefaults() {
        // Common
        els.analytic.value = COMMON_DEFAULTS.analytic;
        els.method.value = COMMON_DEFAULTS.method;
        els.orgUnit.value = COMMON_DEFAULTS.orgUnit;
        els.startDate.value = COMMON_DEFAULTS.startDate;
        els.endDate.value = COMMON_DEFAULTS.endDate;
        els.visualizeAllMethods.value = COMMON_DEFAULTS.visualizeAllMethods;

        // Tab-specific
        els.baseUrl.value = ENDPOINTS[activeTab].baseUrl;
        hydratePlotTypeOptions();
        els.plotType.value = ENDPOINTS[activeTab].defaultPlotType;

        if (activeTab === "anomalies") {
            els.normalRangeWidth.value = ENDPOINTS.anomalies.defaults.normal_range_width;
            els.maxAnomalies.value = ENDPOINTS.anomalies.defaults.max_anomalies;
        }

        loadChart();
    }

    // --- Bind events ---
    els.tabTimeSeries.addEventListener("click", () => setTab("time_series"));
    els.tabAnomalies.addEventListener("click", () => setTab("anomalies"));

    els.loadBtn.addEventListener("click", loadChart);
    els.resetBtn.addEventListener("click", resetDefaults);

    // Press Enter anywhere to load
    document.addEventListener("keydown", (e) => {
        if (e.key === "Enter") loadChart();
    });

    // --- Initial boot ---
    (function init() {
        // set common defaults
        els.analytic.value = COMMON_DEFAULTS.analytic;
        els.method.value = COMMON_DEFAULTS.method;
        els.orgUnit.value = COMMON_DEFAULTS.orgUnit;
        els.startDate.value = COMMON_DEFAULTS.startDate;
        els.endDate.value = COMMON_DEFAULTS.endDate;
        els.visualizeAllMethods.value = COMMON_DEFAULTS.visualizeAllMethods;

        // Start on time series tab
        setTab("time_series");
    })();
</script>

</body>
</html>
